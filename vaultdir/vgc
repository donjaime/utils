#!/bin/bash

VAULT_DIR="$1"
FILE_LIMIT="$2"

if [ ! -n "$VAULT_DIR" ]
then
  echo "Vault dir is missing"
  exit 1
fi

if [ ! -n "$FILE_LIMIT" ]
then
  echo "File limit must be set"
  exit 1
fi

if [ "$FILE_LIMIT" -le 0 ]
then
  echo "File limit must be greater than 0"
  exit 1
fi

if [ ! -d "$VAULT_DIR" ]; then
  echo "Folder \"$VAULT_DIR\" does not exists."
  exit 1
fi

# Tail takes 1+how many we want to keep.
limitarg=$(("$FILE_LIMIT" + 1))

# Remove the list of files generated by:
# - Lexicographically sort in reverse order. Newest at the top.
# - tail -n +LINES will print all except LINES-1.
FILES_TO_DELETE=$(find "$VAULT_DIR"/vault-* -type f | sort -r | tail -n "+$limitarg")
if [ ! -n "$FILES_TO_DELETE" ]
then
  echo "Nothing to GC"
  exit 0
fi

echo "Will delete $(echo "$FILES_TO_DELETE" | wc -l) files:"
echo "$FILES_TO_DELETE"

read -p "'y' to proceed. 'n' to abort [y]: " answer
if [[ $answer = "y" ]] || [ ! -n "$answer" ]
then
  RED='\033[0;31m'
  NC='\033[0m' # No Color
  echo -e "${RED}Deleting:${NC}"
  for file in $FILES_TO_DELETE
  do
    echo "$file"
    rm -f "$file"
  done

else
  echo "Aborted. Doing nothing..."
  exit 0
fi

echo "Done"
